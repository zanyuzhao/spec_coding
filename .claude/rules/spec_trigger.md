# Spec 自动触发

你负责根据用户**当前这句话的意图**决定是否走 Spec 流程，用户不需要知道「要先写 spec」或项目流程。

## 必须走「需求流程」的意图（Spec 或 Harnesses 二选一）

### 新功能 / 修改既有功能

用户在做以下任一表述时，必须走**需求流程**（两种模式二选一）：

- **新功能**：如「加一个登录」「做个订单列表」「支持导出 Excel」。
- **修改既有功能/行为**：如「把登录改成支持手机号」「订单列表要分页」「导出改成 CSV 也要支持」。

**若用户已明确指定模式**（如「用 Spec 做」「走 Harnesses」「按 harnesses 流程」）→ 按指定模式执行。

**若用户未指定模式**，必须先**给出选项**，让开发者选择其一，然后按选择执行：

- **选项 A - Spec 流程**：先写需求说明 + 设计文档，您确认后再实现；适合需精细控制、维护老代码、接口可追溯。
- **选项 B - Harnesses 流程**：由 AI 按 feature list 增量实现，每步 E2E 验收，您少介入；适合快速产出、新功能验证。

回复示例：「本需求可走两种实现模式，请选择：**A) Spec 流程**（先出需求与设计文档，您确认后再实现）或 **B) Harnesses 流程**（AI 按 feature list 逐条实现并 E2E 验收）。请回复 A 或 B。」待用户回复 A/B 后再继续。

### Spec 模式：文档阶段（仅产出文档，然后停止）

当用户选择 **Spec** 或已选过 Spec 时，触发后你必须：

1. 先列出现有 `docs/spec/active/` 避免重复或冲突。
2. 在 `docs/spec/active/` 下创建或更新对应 spec，产出**需求说明文档**与**设计文档**（结构见 `spec_manager.md` 与 `docs/spec_process/SPEC_DOC_TEMPLATE.md`）。
3. **然后停止**：回复中说明「已写好需求说明与设计文档，请查看 `docs/spec/active/` 下 [文件名]。确认无误或修改后，说「继续开发」我再按文档实现。」**不得**在未获用户确认前自动开始写 backend/frontend 代码。

### Harnesses 模式：首轮与后续

当用户选择 **Harnesses** 或已选过 Harnesses 时：

- **首轮（尚未有 feature list / init.sh / progress）**：执行 Skill `harnesses_initializer`：根据用户目标产出高层范围说明、`feature_list.json`、`init.sh`、`claude-progress.txt`（或等价），并做初始提交；然后说明「下一轮说「继续」或「下一轮」将按单 feature 增量实现」。
- **后续轮（已有 feature list 与 progress）**：执行 Skill `harnesses_coding_session`：读 feature list 与 progress，选一个未完成 feature → 跑 init + 基线 E2E → 实现该条 → verify（build + test + E2E）→ 通过则标 passes，更新 progress 并提交。

### 继续开发（仅 Spec 模式；用户确认文档后）

当用户**已看过或修改过**需求/设计文档，并明确要求进入实现时，才执行开发（仅适用于当前需求走的是 **Spec** 模式时）：

- **视为「继续开发」的表述**：如「继续开发」「按文档开发」「文档没问题，开始实现」「就按这个做」「开始实现」。
- **此时你才**：加载并执行 Skill **`spec_implementation_phase`**：按设计文档拆任务（plan）→ TDD 实现 → verify（设计文档中的验收命令 + build + lint）→ 失败则修到过 → code-review → 请人类验收；按 `docs/spec_process/CHECKLISTS.md` 开发清单执行。

## 不触发 Spec 流程的意图

以下情况**不要**走 Spec 流程，直接响应即可：

- **修 Bug**：如「这里报错」「登录后跳转错了」「列表不刷新」——直接改代码，不新建/不强制改 spec。
- **提问/解释**：如「这段是干啥的」「OpenSpec 是什么」「怎么部署」——直接回答，不写 spec。
- **设计/流程讨论**：如「帮忙设计鉴权方案」「评估一下用 Redis 还是 DB」——只讨论或给建议，不视为「要实现新功能」时不写 spec；若用户随后明确说「就按这个做」，再触发 spec 并实现。
- **重构/代码质量**：如「把这段抽成函数」「加类型」「修 lint」且未改变对外行为——不触发；若涉及对外接口或行为变更，则触发。

## 归档触发（仅限用户明确说出）

**只有**用户**明确**说出要归档时，才执行归档流程（校验 → 完善文档 → 合并 delta → 移入 archive → 清理）。不做任何自动推断——不根据「下一个需求」「谢谢」「做完了」等猜测用户要归档。

**视为明确归档的表述**：如「归档」「开发完成」「当前需求归档」「把 [需求名] 归档」「需求收尾」。

**不说的后果**：用户开发完直接关聊天、开新窗口，不会触发归档；后果仅是 `docs/spec/active/` 里未归档项会越来越多，无其他副作用。README 中已强制要求用户记得在开发完成后主动说「开发完成」或「归档」。

## 判断不清时

若无法从当前一句判断是「新功能/改需求」还是「修 bug/提问」：先按**不触发**处理，直接回应；若用户补充说要做成正式功能或改产品行为，再补走 Spec 流程并说明已补录需求。
