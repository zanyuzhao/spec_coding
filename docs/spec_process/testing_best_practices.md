# 测试最佳实践与可选性设计

本文档提供在 Spec 驱动开发框架中关于单元测试和集成测试的**最佳实践指导**。默认情况下，测试是**可选的**，旨在提供灵活性，而非对所有任务施加强制要求。项目可根据自身需求，选择性地采纳或通过明确的规则强制执行。

## 一、默认可选性原则

- **通用框架核心**：本框架的通用核心不强制所有任务都必须编写单元测试或集成测试。默认情况下，AI 在处理任务时，会参考本文档但不会默认生成测试代码，除非有明确指示。
- **为何可选**：旨在平衡开发效率与代码质量，适应不同项目阶段（如快速原型 vs 生产级应用）和不同任务复杂度（如简单 CRUD vs 复杂算法）。

## 二、如何选择性地引入与强制测试

项目可以根据自身对代码质量、可维护性、健壮性的要求，通过以下方式，灵活地引入或强制执行测试：

### 2.1 在 Spec 的 `tasks.md` 中明确列出

对于每一个具体的需求 Spec (`docs/spec/active/<需求名>/spec.md`)，可以在同目录下创建一个 `tasks.md` 文件。在该文件中，可以明确地列出需要完成的测试任务，例如：

```markdown
# 开发任务清单

- [ ] 实现 `GET /api/user/{id}` 接口
- [ ] 为用户详情接口编写单元测试
- [ ] 更新前端用户详情页面
```

**AI 行为**：当 `tasks.md` 中明确列出测试任务时，AI 会将其视为该 Spec 的一部分，并尝试完成。这是最细粒度的测试强制方式。

### 2.2 在 `CHECKLISTS.md` 开发清单中勾选

`docs/spec_process/CHECKLISTS.md` 中的「开发清单列表」可以作为高层级的检查项。其中可以包含一个关于测试的条目，在项目需要时手动勾选或在对话中提及：

```markdown
### 1.4 可验证与文档

- [ ] 具备可验证方式：可手动调接口、跑测试或看 UI，能确认行为符合 spec。
- [x] （可选）已编写单元测试或集成测试（详见「测试最佳实践」）。
- [ ] 文档/注释与行为一致：...
```

**AI 行为**：当 AI 在执行任务时，会注意到 `CHECKLISTS.md` 中关于测试的提醒。如果用户或上下文明确表明需要完成测试，AI 会遵从。如果未明确指示，则默认不强制执行。

### 2.3 通过项目规则（`.mdc`）强制

对于整个项目或特定子目录（如 `backend/`），可以编写 Cursor 项目规则来强制执行测试。例如，创建一个 `test_coverage.mdc`：

```markdown
---
description: 强制要求后端代码的单元测试覆盖率
globs: backend/**/*.py
alwaysApply: false
---

# 后端单元测试覆盖率要求

在修改 `backend/` 下的 Python 代码时，新增或修改的功能必须包含对应的单元测试，且测试通过。

## 强制要求

1. **新增功能**：必须有至少一个单元测试覆盖核心逻辑。
2. **修改功能**：必须更新现有单元测试以覆盖新行为，或新增测试。
3. **测试通过**：所有后端单元测试必须通过。

## AI 行为

当本规则生效时，AI 在完成 `backend/` 代码修改后，会尝试生成/更新并运行单元测试，确保测试通过后再完成任务。
```

**AI 行为**：当此类规则被激活时，AI 会在受影响的文件或目录范围内，主动执行测试相关的任务。这是最强力的测试强制方式。

### 2.4 通过专门的 Skill 引导

可以编写一个专门的 Skill，用于引导 AI 在特定场景下生成测试代码，或提供测试相关的建议。例如，`/generate-tests` Skill。

## 三、测试工具与环境（示例）

- **后端 (Python)**：
  - **单元测试框架**：`pytest`
  - **断言库**：`pytest` 内置断言
  - **Mock 库**：`unittest.mock` 或 `pytest-mock`
- **前端 (TypeScript/React)**：
  - **单元/集成测试框架**：`Jest` 或 `Vitest`
  - **React 组件测试**：`React Testing Library`

配置与运行方式详见项目 `backend/pyproject.toml` (pytest) 和 `frontend/package.json` (Jest/Vitest)。

## 四、总结

通过上述组合拳，可以实现在通用 AI 编程框架中，测试的最佳实践能够被清晰地传达，并且可以根据项目或任务的实际需求，灵活地选择是作为**可选指导**还是**强制执行**。